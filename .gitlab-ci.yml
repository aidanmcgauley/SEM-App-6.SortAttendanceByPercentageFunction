image: node:14-alpine

stages:
    - test
    - deploy

test:
    stage: test
    script:
        - npm install
        - npm test

# Testing to see if the cache speeds up subsequent builds
cache:
    paths:
        - node_modules/

deploy:
  stage: deploy
  only:
    - master # Deploy only on the master branch
  script:
    # Install dependencies
    - apk --no-cache add curl bash python3

    # Download and install Google Cloud SDK
    - curl https://sdk.cloud.google.com | bash
    - source $HOME/google-cloud-sdk/path.bash.inc

    # Deploy
    - echo $GCP_SERVICE_ACCOUNT_KEY > gcp-service-account-key.json
    - gcloud auth activate-service-account --key-file gcp-service-account-key.json
    - gcloud config set project radiant-destiny-392018
    - gcloud builds submit --config cloudbuild.yaml .